name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt || echo "No requirements.txt"
      
      - name: Package Chrome Extension
        run: |
          cd chrome-extension
          zip -r ../chrome-extension.zip . -x "*.DS_Store" -x "__pycache__/*"
          cd ..
          echo "âœ… Chrome extension packaged"
      
      - name: Create Release Archive
        run: |
          mkdir -p release
          # Copy main application files
          cp -r templates release/
          cp -r frontend release/
          cp main.py release/
          cp data.json release/ || echo "No data.json"
          cp è´·æ¬¾åˆ°æœŸæ¸…å•.xlsx release/ || echo "No Excel file"
          cp README.md release/ || echo "No README"
          # Add Chrome extension zip
          cp chrome-extension.zip release/
          # Create final archive
          cd release
          zip -r ../é“¶è¡ŒåˆåŒå¥—æ‰“ç³»ç»Ÿ-${GITHUB_REF_NAME:-latest}.zip . -x "*.DS_Store" -x "__pycache__/*"
          cd ..
          echo "âœ… Release archive created"
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            é“¶è¡ŒåˆåŒå¥—æ‰“ç³»ç»Ÿ-*.zip
            chrome-extension.zip
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            **åŒ…å«å†…å®¹ï¼š**
            - âœ… åç«¯æœåŠ¡ (FastAPI)
            - âœ… å‰ç«¯ç•Œé¢ (React)
            - âœ… Chromeæµè§ˆå™¨æ’ä»¶
            - âœ… æ–‡æ¡£æ¨¡æ¿
            - âœ… åˆ°æœŸå®¢æˆ·Excelæ–‡ä»¶
            
            **Chromeæ’ä»¶å®‰è£…ï¼š**
            1. ä¸‹è½½ `chrome-extension.zip`
            2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
            3. Chromeè®¿é—® `chrome://extensions/`
            4. å¯ç”¨"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
            
            **ä½¿ç”¨æ–‡æ¡£ï¼š** æŸ¥çœ‹ README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-package
          path: |
            é“¶è¡ŒåˆåŒå¥—æ‰“ç³»ç»Ÿ-*.zip
            chrome-extension.zip
          retention-days: 30
